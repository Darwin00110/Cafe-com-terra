<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Café com Terra - Gerenciamento de Pedidos</title>
    <link rel="icon" href="./Imagens/iconSite.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        
        body {
            background-color: #493628;
            color: white;
        }

        .texto {
            font-size: 2.5rem;
            font-weight: 500;
            grid-row: 2;
        }

        .main {
            display: grid;
            grid-template-rows: 11rem auto;
            background-color: #242424;
            color: white;
            font-weight: 700;
        }

        .styleElements {
            background-color: #343434;
            color: white;
        }

        .styleElements:focus {
            background-color: #343434;
            color: white;
        }

        .container {
            display: grid;
        }

        .imagem {
            margin: auto;
        }

        .styleContainer {
            margin-top: 1.2rem;
        }

        .stylePedidos {
            background-color: #242424;
            color: white;
            border-radius: 8px;
        }
        .stylePedidos2 {
            background-color: #343434;
            color: white;
            border-radius: 8px;
        }

    </style>
</head>

<body>
    <div class="container py-2 styleContainer">
        
        <!-- Formulário para novo pedido -->
        <div class="card mb-4">
            <div class="card-body main">
                <img src="./Imagens/logoSite-removebg-preview.png" width="200" class="imagem">
                <h1 class="display-5 text-center texto">Café com Terra - Gerenciamento de Pedidos</h1>
                <h2 class="card-title h4 mb-3">Registrar Novo Pedido</h2>
                <form id="orderForm" method="POST">
                    <div class="mb-3">
                        <label for="customerName" class="form-label">Nome do Cliente</label>
                        <input type="text" id="customerName" class="form-control styleElements" required>
                    </div>
                    <div class="mb-3">
                        <label for="item" class="form-label">Item do Pedido</label>
                        <select type="text" id="item" class="form-control styleElements" required>
                            <option value="café tradicional">café tradicional</option>
                            <option value="coxinha">coxinha</option>
                            <option value="café da fazenda">café da fazenda</option>
                            <option value="bolo de fubá da casa">bolo de fubá da casa</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="quantity" class="form-label">Quantidade</label>
                        <input type="number" id="quantity" class="form-control styleElements" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label for="details" class="form-label">Detalhes do Pedido</label>
                        <textarea id="details" class="form-control styleElements" rows="4"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="paymentMethod" class="form-label">Método de Pagamento</label>
                        <select id="paymentMethod" class="form-select styleElements" required>
                            <option value="" disabled selected>Selecione o método</option>
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="Cartão de Crédito">Cartão de Crédito</option>
                            <option value="Cartão de Débito">Cartão de Débito</option>
                            <option value="Pix">Pix</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success" name="SalvarAlteracoes">Adicionar Pedido</button>
                </form>
            </div>
        </div>

        <!-- Lista de pedidos -->
        <div class="card">
            <div class="card-body stylePedidos">
                <h2 class="card-title h4 mb-3">Pedidos Registrados</h2>
                <ul id="orderList" class="list-group"></ul>
            </div>
        </div>

        <!-- Modal para edição de pedidos -->
        <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header stylePedidos">
                        <h5 class="modal-title" id="editModalLabel">Editar Pedido</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body stylePedidos">
                        <form id="editForm">
                            <input type="hidden" id="editOrderId">
                            <div class="mb-3">
                                <label for="editCustomerName" class="form-label">Nome do Cliente</label>
                                <input type="text" id="editCustomerName" name="NomeCliente" class="form-control styleElements" required>
                            </div>
                            <div class="mb-3">
                                <label for="editItem" class="form-label">Item do Pedido</label>
                                <input type="text" id="editItem" name="ItemPedido" class="form-control styleElements" required>
                            </div>
                            <div class="mb-3">
                                <label for="editQuantity" class="form-label">Quantidade</label>
                                <input type="number" id="editQuantity" name="Quantidade" class="form-control styleElements" min="1" required>
                            </div>
                            <div class="mb-3">
                                <label for="editDetails" class="form-label">Detalhes do Pedido</label>
                                <textarea id="editDetails" name="DetalhesPedido" class="form-control styleElements" rows="4"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="editPaymentMethod" class="form-label">Método de Pagamento</label>
                                <select id="editPaymentMethod" name="FormaDePagamento" class="form-select styleElements" required>
                                    <option value="" disabled>Selecione o método</option>
                                    <option value="Dinheiro">Dinheiro</option>
                                    <option value="Cartão de Crédito">Cartão de Crédito</option>
                                    <option value="Cartão de Débito">Cartão de Débito</option>
                                    <option value="Pix">Pix</option>
                                </select>
                            </div>
                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" id="cancelEdit" class="btn btn-secondary"
                                    data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-success">Salvar Alterações</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <?php 
        if($_SERVER['REQUEST_METHOD'] === "POST"){
            $servername = "localhost";
            $username = "root";   // padrão do XAMPP
            $password = "";       // vazio no XAMPP
            $dbname = "cafécomterra";
            $port = 3307;         // troque se usar outra porta

            $conn = new mysqli($servername, $username, $password, $dbname, $port);
            
            if ($conn->connect_error) {
                die("Falha na conexão: " . $conn->connect_error);
            }

        if(isset($_POST['SalvarAlteracoes'])){
            $NomeCliente = $_POST['NomeCliente'] ?? null; 
            $ItemPedido = $_POST['ItemPedido'] ?? null;
            $Quantidade = $_POST['Quantidade'] ?? null;
            $DetalhesPedido = $_POST['DetalhesPedido'] ?? null;
            $FormaDePagamento = $_POST['FormaDePagamento'] ?? null;
                    
            $preco = null;
            switch ($ItemPedido) {
                case 'café tradicional': $preco = 4.50; break;
                case 'coxinha': $preco = 7.00; break;
                case 'café da fazenda': $preco = 9.00; break;
                case 'bolo de fubá da casa': $preco = 6.00; break;
            }
        
            $queryCadastroPedidos = $conn->prepare(
                "INSERT INTO pedidos(nomeCliente, itemDoPedido, quantidade, detalhesDoProduto, metodoDePagamento, preco) 
                 VALUES (?, ?, ?, ?, ?, ?)"
            );
            $queryCadastroPedidos->bind_param("ssissd", 
                $NomeCliente, $ItemPedido, $Quantidade, $DetalhesPedido, $FormaDePagamento, $preco
            );
        
            if($queryCadastroPedidos->execute()){
                echo "Pedido enviado com sucesso!";
            } else {
                echo "Erro ao enviar o pedido: " . $conn->error;
            }
        
            $queryCadastroPedidos->close();   
        }
        }
    
    
    
    
    
    ?>

    <script>
        // Carregar pedidos do localStorage
        let orders = JSON.parse(localStorage.getItem('orders')) || [];

        // Função para salvar pedidos no localStorage
        function saveOrders() {
            localStorage.setItem('orders', JSON.stringify(orders));
        }

        // Função para renderizar a lista de pedidos
        function renderOrders() {
            const orderList = document.getElementById('orderList');
            orderList.innerHTML = '';
            orders.forEach((order, index) => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center stylePedidos2';
                li.innerHTML = `
          <div>
            <p><strong>Cliente:</strong> ${order.customerName}</p>
            <p><strong>Item:</strong> ${order.item} (x${order.quantity})</p>
            <p><strong>Detalhes:</strong> ${order.details || 'Nenhum'}</p>
            <p><strong>Pagamento:</strong> ${order.paymentMethod}</p>
          </div>
          <div>
            <button onclick="editOrder(${index})" class="btn btn-warning btn-sm me-2">Editar</button>
            <button onclick="deleteOrder(${index})" class="btn btn-danger btn-sm">Excluir</button>
          </div>
        `;
                orderList.appendChild(li);
            });
        }

        // Função para adicionar um novo pedido
        document.getElementById('orderForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const order = {
                customerName: document.getElementById('customerName').value,
                item: document.getElementById('item').value,
                quantity: document.getElementById('quantity').value,
                details: document.getElementById('details').value,
                paymentMethod: document.getElementById('paymentMethod').value,
            };
            orders.push(order);
            saveOrders();
            renderOrders();
            e.target.reset();
        });

        // Função para abrir o modal de edição
        function editOrder(index) {
            const order = orders[index];
            document.getElementById('editOrderId').value = index;
            document.getElementById('editCustomerName').value = order.customerName;
            document.getElementById('editItem').value = order.item;
            document.getElementById('editQuantity').value = order.quantity;
            document.getElementById('editDetails').value = order.details;
            document.getElementById('editPaymentMethod').value = order.paymentMethod;
            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        // Função para salvar alterações do pedido
        document.getElementById('editForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const index = document.getElementById('editOrderId').value;
            orders[index] = {
                customerName: document.getElementById('editCustomerName').value,
                item: document.getElementById('editItem').value,
                quantity: document.getElementById('editQuantity').value,
                details: document.getElementById('editDetails').value,
                paymentMethod: document.getElementById('editPaymentMethod').value,
            };
            saveOrders();
            renderOrders();
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
        });

        // Função para cancelar a edição
        document.getElementById('cancelEdit').addEventListener('click', () => {
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
        });

        // Função para excluir um pedido
        function deleteOrder(index) {
            if (confirm('Tem certeza que deseja excluir este pedido?')) {
                orders.splice(index, 1);
                saveOrders();
                renderOrders();
            }
        }

        // Renderizar pedidos ao carregar a página
        renderOrders();
    </script>
</body>

</html>